<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HappyCorner | Pedido</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #fff;
      color: #222;
      margin: 0;
      padding: 0;
    }
    h1 {
      text-align: center;
      margin-top: 1rem;
    }
    form {
      max-width: 420px;
      margin: 2rem auto;
      padding: 1.5rem;
      background: #fafafa;
      border-radius: 16px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    input, select, button {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
    }
    button {
      background: #14b8a6;
      color: white;
      border: none;
      cursor: pointer;
      transition: background .2s;
    }
    button:hover {
      background: #0d9488;
    }
    #consultarPuntosBtn {
      background: #3b82f6;
    }
    #consultarPuntosBtn:hover {
      background: #2563eb;
    }
    .hidden { display: none; }
    @keyframes fade-in { from { opacity: 0; transform: scale(.95); } to { opacity: 1; transform: scale(1); } }
    .animate-fade-in { animation: fade-in .2s ease-in-out; }
  </style>
</head>
<body>

  <h1>üçï Pedido HappyCorner</h1>

  <form id="checkoutForm" action="https://formsubmit.co/evanlensenmo@gmail.com" method="POST">
    <input type="text" id="nombre" name="Nombre" placeholder="Tu nombre" required>
    <input type="email" id="email" name="Correo" placeholder="Tu correo" required>
    <input type="tel" id="celular" name="Celular" placeholder="Tu n√∫mero de contacto" required>

    <div style="display:flex; gap:8px;">
      <input type="text" id="puntosCodeInput" placeholder="HappyC√≥digo" style="flex:1;">
      <button type="button" id="consultarPuntosBtn" onclick="applyHappyPuntos()">Consultar</button>
    </div>

    <select id="producto" name="Producto" required>
      <option value="">Selecciona tu producto</option>
      <option value="Oka Loka (caja)">Oka Loka (caja)</option>
      <option value="Oka Loka (bolsa)">Oka Loka (bolsa)</option>
      <option value="Gomitas">Gomitas</option>
      <option value="Barquillos">Barquillos</option>
      <option value="Bombombum">Bombombum</option>
      <option value="HappyPizza Normal">HappyPizza Normal</option>
      <option value="HappyPizza X2 Queso">HappyPizza X2 Queso</option>
      <option value="80 RBX">80 RBX</option>
    </select>

    <input type="number" id="cantidad" name="Cantidad" placeholder="Cantidad" min="1" required>

    <textarea id="notas" name="Notas" rows="2" placeholder="Notas adicionales (opcional)"></textarea>

    <input type="hidden" name="_next" value="https://happycorner.lol/confirmed.html">
    <input type="hidden" name="_captcha" value="false">

    <button type="submit" id="enviarPedidoBtn">Enviar pedido</button>
  </form>

  <!-- MODAL -->
  <div id="happy-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-lg p-6 w-[90%] max-w-md text-center animate-fade-in">
      <h2 class="text-xl font-semibold mb-2">üéâ HappyC√≥digo v√°lido</h2>
      <p id="happy-modal-msg" class="text-gray-700 whitespace-pre-line mb-4"></p>
      <div class="flex justify-center gap-3">
        <button id="happy-modal-apply" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">Aplicar</button>
        <button id="happy-modal-cancel" class="px-4 py-2 bg-gray-300 text-black rounded-lg hover:bg-gray-400 transition">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
  const VERCEL_API_BASE_URL = 'https://happy-corner.vercel.app/api';
  const checkoutForm = document.getElementById('checkoutForm');
  const puntosCodeInput = document.getElementById('puntosCodeInput');
  const consultarPuntosBtn = document.getElementById('consultarPuntosBtn');
  const cantidadInput = document.getElementById('cantidad');
  const productoSelect = document.getElementById('producto');

  function showToast(msg) {
    const toast = document.createElement('div');
    toast.textContent = msg;
    toast.className = 'fixed bottom-4 left-1/2 -translate-x-1/2 bg-black text-white text-sm px-4 py-2 rounded-lg shadow-md opacity-0 transition';
    document.body.appendChild(toast);
    setTimeout(() => toast.style.opacity = '1', 10);
    setTimeout(() => {
      toast.style.opacity = '0';
      setTimeout(() => toast.remove(), 500);
    }, 2500);
  }

  async function applyHappyPuntos() {
    const code = puntosCodeInput.value.trim();
    if (!code) {
      showToast('‚ö†Ô∏è Ingresa tu HappyC√≥digo primero.');
      return;
    }

    consultarPuntosBtn.disabled = true;
    consultarPuntosBtn.textContent = 'Consultando...';

    try {
      const res = await fetch(`${VERCEL_API_BASE_URL}/getPoints?codigo=${encodeURIComponent(code)}`);
      const data = await res.json();

      if (!res.ok) {
        showToast(`‚ùå ${data.error || 'No se pudo verificar el c√≥digo.'}`);
        return;
      }

      const msgLines = [
        `üë§ ${data.nombre}`,
        `üìß ${data.correo}`,
        `üíé Puntos: ${data.puntos.toLocaleString('es-CO')}`,
        '',
        data.ultimas_transacciones?.length
          ? 'üõçÔ∏è √öltimos pedidos:\n' +
            data.ultimas_transacciones.slice(0, 3).map(
              (r, i) => `${i + 1}. ${r.fecha} ‚Äî $${r.total.toLocaleString('es-CO')}`
            ).join('\n')
          : 'No se encontraron pedidos recientes.'
      ];
      document.getElementById('happy-modal-msg').textContent = msgLines.join('\n');

      const modal = document.getElementById('happy-modal');
      modal.classList.remove('hidden');

      const applyBtn = document.getElementById('happy-modal-apply');
      const cancelBtn = document.getElementById('happy-modal-cancel');
      applyBtn.onclick = null;
      cancelBtn.onclick = null;

      applyBtn.onclick = () => {
        document.getElementById('nombre').value = data.nombre || '';
        document.getElementById('email').value = data.correo !== 'No registrado' ? data.correo : '';
        document.getElementById('celular').value = '';
        modal.classList.add('hidden');
        showToast('‚úÖ Datos aplicados con √©xito.');

        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'HappyC√≥digo';
        hiddenInput.value = data.happyCodigo;
        checkoutForm.appendChild(hiddenInput);
      };

      cancelBtn.onclick = () => {
        modal.classList.add('hidden');
        showToast('Operaci√≥n cancelada.');
      };

    } catch (err) {
      console.error('Error al consultar Happy Puntos:', err);
      showToast('‚ùå Error al conectar con el servidor.');
    } finally {
      consultarPuntosBtn.disabled = false;
      consultarPuntosBtn.textContent = 'Consultar';
    }
  }

  // VALIDAR ANTES DE ENVIAR
  checkoutForm.addEventListener('submit', function(e) {
    const producto = productoSelect.value;
    const cantidad = parseInt(cantidadInput.value);

    // L√≠mite para pizzas traviesas
    if ((producto === 'HappyPizza Normal' || producto === 'HappyPizza X2 Queso') && cantidad > 5) {
      e.preventDefault();
      showToast('üçï L√≠mite: m√°ximo 5 por tipo de HappyPizza.');
      return;
    }

    // Ajustar formato bonito del correo (sin \n\n)
    const resumen = 
`Resumen del Pedido:
Producto: ${producto}
Cantidad: ${cantidad}
Notas: ${document.getElementById('notas').value || 'Sin notas.'}`;

    const resumenInput = document.createElement('input');
    resumenInput.type = 'hidden';
    resumenInput.name = 'Resumen_del_Pedido';
    resumenInput.value = resumen;
    checkoutForm.appendChild(resumenInput);
  });
  </script>
</body>
</html>
