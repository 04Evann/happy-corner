<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Happy Shop - Happy Order üõí</title>
    
    <link rel="icon" type="image/png" href="/happyfavicon.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* Base Styles & Mobile First */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        /* PALETA NAVIDE√ëA VERDE Y ORO/ROJO (Verificada) */
        :root {
            --navidad-verde-oscuro: #004d40; /* Verde Bosque, para Header, Footer, Botones (hover) */
            --navidad-verde-claro: #388e3c; /* Verde Pino, para Acentos, T√≠tulos */
            --navidad-rojo-clasico: #d32f2f; /* Rojo de Baya, para Acentos y Botones */
            --navidad-blanco-nieve: #f0f8ff; /* Fondo principal */
            --navidad-oro: #ffd700; /* Toque especial */
            --navidad-crema: #fffdf7; /* Fondo de tarjetas */
            --text-dark: #222;
            --text-light: #f0f8ff;
        }
        
        /* ANIMACI√ìN DE NIEVE */
        @keyframes snowfall {
            0% { background-position: 0 0; }
            100% { background-position: 500px 500px; }
        }

        body {
            background-color: var(--navidad-blanco-nieve);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Ccircle cx='5' cy='5' r='1' fill='%23ffffff80'/%3E%3C/svg%3E");
            background-size: 10px 10px;
            animation: snowfall 10s linear infinite;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Colores base */
        * { color: var(--text-dark); }
        header * { color: var(--text-light); }
        .item-price, .total-price, #happy-code-display { color: var(--navidad-oro); }
        nav a { color: var(--navidad-verde-oscuro); } 


        /* --- Header (Mismo que Cat√°logo) --- */
        header {
            background: linear-gradient(to right, var(--navidad-verde-oscuro), var(--navidad-verde-claro)); 
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 100;
            min-height: 80px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2); 
        }

        header img {
            height: 65px;
            max-width: 80%;
            object-fit: contain;
            object-position: left;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.5)); 
        }

        .menu-btn {
            font-size: 2rem;
            background: none;
            border: none;
            cursor: pointer;
            z-index: 101;
            color: var(--navidad-blanco-nieve);
            display: block;
        }

        nav {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 1rem 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            z-index: 100;
        }

        nav.open { display: flex; }

        nav a {
            color: var(--navidad-verde-oscuro);
            text-decoration: none;
            padding: 0.8rem 1.5rem;
            font-weight: 600;
            transition: color 0.3s ease, background-color 0.3s ease;
        }

        nav a:hover {
            color: var(--navidad-rojo-clasico);
            background-color: rgba(56, 142, 60, 0.1);
        }

        /* --- Main Content Layout --- */
        main {
            flex-grow: 1; 
            padding: 2rem 1rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* --- Section Title --- */
        .page-title {
            text-align: center;
            font-size: 2.2rem;
            font-weight: 700;
            margin: 1rem 0 2rem;
            color: var(--navidad-verde-claro);
            position: relative;
            padding-bottom: 10px;
        }

        .page-title::after {
            content: 'üõçÔ∏è'; 
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5rem;
            color: var(--navidad-rojo-clasico); 
            bottom: -10px;
            width: auto;
            height: auto;
            background-color: transparent;
            border-radius: 0;
        }
        .page-title::before {
            content: '';
            position: absolute;
            left: 50%;
            bottom: 0;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background-color: var(--navidad-rojo-clasico); 
            border-radius: 2px;
        }

        /* --- Order/Cart Details --- */
        .order-container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        
        .order-summary, .checkout-form {
            background: var(--navidad-crema); 
            padding: 1.5rem;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--navidad-verde-claro);
        }
        
        .order-summary h2, .checkout-form h2 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--navidad-verde-oscuro);
            border-bottom: 2px solid var(--navidad-rojo-clasico);
            padding-bottom: 0.5rem;
        }

        /* --- Product List (Cart) --- */
        #cart-items-list {
            list-style: none;
            padding: 0;
        }

        #cart-items-list li {
            display: flex;
            justify-content:space-between; 
            align-items:center;
            padding: 10px 0;
            border-bottom: 1px dashed var(--navidad-verde-claro);
            font-size: 0.95rem;
        }

        .item-details .item-name{ font-weight: 600; color: var(--navidad-verde-oscuro); }
        .item-details .item-price{ font-size:0.85rem; color: #666; }
        
        .item-controls button{ 
            background: var(--navidad-rojo-clasico);
            color: white;
            border:none; 
            border-radius:50%; 
            width:28px; 
            height:28px; 
            font-size:1.2rem; 
            cursor:pointer; 
            transition:background .2s; 
            border: 1px solid var(--navidad-oro);
        }
        .item-controls button:hover{ background: var(--navidad-verde-oscuro); }
        .item-total{ font-weight:700; color: var(--navidad-rojo-clasico); min-width:60px; text-align:right; }

        /* --- Cart Summary --- */
        .order-totals {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid var(--navidad-rojo-clasico);
        }
        
        .order-totals .total-price {
            color: var(--navidad-verde-claro);
            font-size: 1.5rem;
            font-weight: 800;
        }
        
        /* --- Contact Form --- */
        .checkout-form label{ 
            color:var(--navidad-verde-oscuro); 
            display: block; /* Asegura que las etiquetas est√©n en su propia l√≠nea */
            margin-bottom: 5px;
            font-weight: 500;
        }

        /* CAMPOS DE FORMULARIO REDONDEADOS Y BONITOS */
        .checkout-form input, .checkout-form textarea, .checkout-form select{ 
            width: 100%; 
            padding: 10px;
            margin-bottom: 15px; 
            border-radius: 8px; /* BORDE REDONDO */
            border:1px solid var(--navidad-verde-claro); 
            background:white; 
            font-size: 1rem;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05); /* Sutil sombra interna */
        }
        
        .checkout-form input:focus, .checkout-form textarea:focus, .checkout-form select:focus{ 
            border-color:var(--navidad-rojo-clasico); 
            box-shadow:0 0 5px rgba(211, 47, 47, 0.5); 
            outline: none;
        }
        
        /* Contenedor para agrupar campos y ponerlos en l√≠nea en escritorio */
        .checkout-form .form-group-inline {
            display: flex;
            gap: 15px;
            flex-direction: column; /* Vertical en m√≥vil */
            margin-bottom: 10px; /* Espacio extra para grupos */
        }
        
        .checkout-form .form-group-inline > div {
            flex: 1;
        }
        /* FIN DE MEJORAS DE FORMULARIO */

        .checkout-form button[type="submit"]{ 
            background-color: var(--navidad-verde-claro); 
            transition: background-color 0.3s ease, transform 0.2s ease;
            padding: 1rem;
            border-radius: 8px;
            color: white;
            border: none;
            width: 100%;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 700;
            margin-top: 15px;
        }
        
        .checkout-form button[type="submit"]:hover {
            background-color: var(--navidad-rojo-clasico);
        }
        
        .checkout-form button[type="submit"]:disabled { 
            background-color: #aaa; 
            cursor: not-allowed;
        }
        
        /* Estilos de pago */
        .payment-details {
            background: rgba(56, 142, 60, 0.05); 
            border: 1px dashed var(--navidad-verde-claro);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            margin-bottom: 15px;
        }

        .payment-details p { color: var(--navidad-verde-oscuro); margin: 5px 0; }
        .payment-details a { color: var(--navidad-rojo-clasico); font-weight: 700;}
        .payment-details img { border: 2px solid var(--navidad-oro); }
        
        /* Bot√≥n de consultar puntos */
        #consultar-puntos-btn {
            background:var(--navidad-rojo-clasico) !important;
            color: white !important;
            padding: 0.8rem 1rem !important;
            border-radius: 8px !important;
            height: 44px;
        }
        #consultar-puntos-btn:hover {
             background:var(--navidad-verde-oscuro) !important;
        }
        
        #ultimos-pedidos {
            background:rgba(211, 47, 47, 0.05) !important;
            border:1px dashed var(--navidad-rojo-clasico) !important;
        }


        /* --- Modal de Confirmaci√≥n --- */
        .modal {
            display: none; /* Oculto por defecto */
            position: fixed; 
            z-index: 200; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: var(--navidad-crema);
            margin: auto;
            padding: 30px;
            border: 5px solid var(--navidad-rojo-clasico);
            width: 90%;
            max-width: 400px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .modal-content h4 {
            color: var(--navidad-verde-claro);
            font-size: 1.8rem;
            margin-bottom: 15px;
        }

        .modal-content p {
            color: var(--navidad-verde-oscuro);
            margin-bottom: 10px;
        }

        #happy-code-display {
            background-color: var(--navidad-verde-oscuro);
            color: var(--navidad-oro);
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 1.4rem;
            font-weight: 700;
            display: inline-block;
            margin: 10px 0 20px;
        }
        
        .modal-close-btn {
            background-color: var(--navidad-rojo-clasico);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .modal-close-btn:hover {
            background-color: var(--navidad-verde-oscuro);
        }

        /* --- Footer (Mismo que Cat√°logo) --- */
        footer {
            background: var(--navidad-verde-oscuro);
            padding: 2rem 1rem;
            text-align: center;
            margin-top: 3rem;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
        }

        footer * { color: var(--text-light); }
        .social-icons a { color: var(--navidad-oro); }
        .social-icons a:hover { color: var(--navidad-rojo-clasico); }
        .footer-links a { color: var(--navidad-blanco-nieve); }
        .footer-links a:hover { color: var(--navidad-rojo-clasico); }
        
        /* --- Media Queries for Desktop --- */
        @media (min-width: 768px) {
            header { padding: 0.5rem 2rem; min-height: 100px; }
            header img { height: 80px; }
            .menu-btn { display: none; }
            nav { position: static; display: flex; flex-direction: row; width: auto; background-color: transparent; backdrop-filter: none; box-shadow: none; padding: 0; }
            nav a { padding: 0.7rem 1.2rem; color: var(--navidad-blanco-nieve); }
            nav a:hover { color: var(--navidad-oro); text-decoration: underline; }

            .order-container {
                flex-direction: row;
                justify-content: space-between;
                align-items: flex-start;
            }
            
            .order-summary {
                flex: 1.5; 
            }

            .checkout-form {
                flex: 1; 
                max-width: 400px;
                position: sticky; 
                top: 20px;
            }
            
            /* Asegura que los campos en l√≠nea se vean bien en escritorio */
             .checkout-form .form-group-inline {
                flex-direction: row; /* Horizontal en escritorio */
             }
        }
    </style>
</head>
<body onload="renderCart()">
    <header>
        <img src="loguito.png" alt="Happy Corner Logo" />
        <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
        <nav id="menu">
            <a href="index.html">Inicio</a>
            <a href="catalogo.html">Cat√°logo</a>
            <a href="order.html">Happy Order</a>
            <a href="puntos.html">Happy Puntos</a>
            <a href="terminos.html">T√©rminos</a>
        </nav>
    </header>

    <main>
        <h1 class="page-title">Tu Happy Order üõí</h1>

        <div class="order-container">
            <section class="order-summary">
                <h2>Resumen de tu Carrito</h2>
                <ul id="cart-items-list"></ul>

                <div class="empty-cart-message" id="empty-cart-msg" style="display:none;">
                    Tu carrito est√° vac√≠o. ¬°Explora el <a href="catalogo.html" style="color:var(--navidad-rojo-clasico); text-decoration: underline;">cat√°logo</a> para empezar a comprar!
                </div>

                <div class="order-totals">
                    <p>Subtotal: <span id="subtotal-price">$0</span></p>
                    <p>Env√≠o: <span id="shipping-price">Gratis</span></p>
                    <p class="total-price">Total: <span id="total-price">$0</span></p>
                </div>
            </section>
            
            <section class="checkout-form">
                <h2>Detalles de Contacto y Pago</h2>
                <form action="https://formsubmit.co/evanlensenmo@gmail.com" method="POST" id="checkout-form">
                    
                    <div style="display:flex;gap:10px;align-items:flex-end;margin-bottom:1.2rem;">
                        <div style="flex-grow:1;">
                            <label for="puntos_code">C√≥digo Happy Puntos (Opcional):</label>
                            <input type="text" id="puntos_code" name="puntos_code" placeholder="Introduce tu c√≥digo" style="margin-bottom:0;" />
                        </div>
                        <button type="button" id="consultar-puntos-btn" style="background:var(--navidad-rojo-clasico);color:white;padding:0.8rem 1rem;border:none;border-radius:8px;cursor:pointer;font-size:0.95rem;font-weight:600;height:44px;transition:background 0.3s;">Consultar</button>
                    </div>

                    <div id="ultimos-pedidos" style="display:none;margin-top:1rem;background:rgba(211, 47, 47, 0.05);border:1px dashed var(--navidad-rojo-clasico);padding:1rem;border-radius:8px;"></div>

                    <label for="nombre">Nombre completo:</label>
                    <input type="text" id="nombre" name="nombre" required placeholder="Tu nombre" />

                    <div class="form-group-inline">
                        <div>
                            <label for="email">Email:</label>
                            <input type="email" id="email" name="email" required placeholder="tucorreo@example.com" />
                        </div>
                        <div>
                            <label for="tipo_entrega">Tipo de Entrega:</label>
                            <select id="tipo_entrega" name="tipo_entrega" required>
                                <option value="">Selecciona una opci√≥n</option>
                                <option value="colegio">Entrega en el Colegio (F√≠sicos)</option>
                                <option value="virtual">Entrega Virtual (Servicios Online)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group-inline">
                        <div>
                            <label for="celular">N√∫mero de Celular (WhatsApp):</label>
                            <input type="text" id="celular" name="celular" required placeholder="Ej: 300 123 4567" />
                        </div>
                        <div>
                            <label for="metodo_pago">M√©todo de pago:</label>
                            <select id="metodo_pago" name="metodo_pago" required>
                                <option value="">Selecciona una opci√≥n</option>
                                <option value="nequi">Nequi</option>
                                <option value="pse">PSE</option>
                                <option value="applepay">Apple Pay</option>
                                <option value="tarjeta">Tarjeta (Cr√©dito / D√©bito)</option>
                                <option value="efectivo">Efectivo (Pago al recibir)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="nequi-details" class="payment-details" style="text-align:center; display:none;">
                        <p>Para pagar por Nequi, transfiere al n√∫mero de HappyCorner. Env√≠a captura a WhatsApp para confirmar.</p>
                        <p>N√∫mero Nequi: (Se te proporcionar√° por WhatsApp)</p>
                        <a href="https://wa.me/34641422390?text=Hola!%20Acabo%20de%20hacer%20un%20pedido%20en%20Happy%20Shop%20y%20quiero%20pagar%20por%20Nequi." target="_blank">Confirmar Pago por WhatsApp</a>
                    </div>

                    <div id="pse-details" class="payment-details" style="display:none;">
                        <p>Para PSE: Te daremos las instrucciones por WhatsApp y env√≠as captura para confirmar.</p>
                        <a href="https://wa.me/34641422390" target="_blank">Confirmar Pago por WhatsApp</a>
                    </div>

                    <div id="applepay-details" class="payment-details" style="display:none;">
                        <p>Pago con Apple Pay v√≠a link (REVOLUT). Contacta por WhatsApp para recibir link.</p>
                        <a href="https://wa.me/34641422390" target="_blank">Continuar por WhatsApp</a>
                    </div>

                    <div id="tarjeta-details" class="payment-details" style="display:none;">
                        <p>Pago con tarjeta v√≠a link (REVOLUT). Contacta por WhatsApp para recibir link.</p>
                        <a href="https://wa.me/34641422390" target="_blank">Continuar por WhatsApp</a>
                    </div>

                    <div id="efectivo-details" class="payment-details" style="display:none;">
                        <p>Paga en efectivo al recibir (si aplica). Ten el valor exacto si puedes.</p>
                    </div>

                    <label for="notas">Notas Adicionales (Opcional):</label>
                    <textarea id="notas" name="notas_adicionales" rows="2" placeholder="Ej: 'Cont√°ctenme antes de entregar.'"></textarea>

                    <input type="hidden" name="_subject" value="Nuevo Pedido Happy Shop!">
                    <input type="hidden" name="_captcha" value="false">
                    <input type="hidden" name="Resumen del Pedido" id="order-summary-input">
                    <input type="hidden" name="Total del Pedido" id="total-price-hidden">
                    <input type="hidden" name="Contenido del Carrito" id="cart-content-hidden">
                    <input type="hidden" name="N√∫mero de Pedido" id="order-number-hidden">
                    <input type="hidden" name="Happy Code" id="happycode-hidden-final">


                    <button type="submit" id="place-order-button" disabled>
                        <i class="fas fa-box-open"></i>
                        Finalizar HappyOrder
                    </button>
                    
                    <p style="text-align:center; font-size:0.8rem; color:#666; margin-top:10px;">
                        *Tu Happy C√≥digo de pedido ser√° generado y enviado.
                    </p>
                </form>
            </section>
        </div>
    </main>

    <div id="order-success-modal" class="modal">
        <div class="modal-content">
            <h4>üéâ ¬°Pedido Generado con √âxito! üéâ</h4>
            <p>Hemos recibido tu Happy Order. Utiliza este c√≥digo para hacer seguimiento y pagar tu compra:</p>
            <span id="happy-code-display"></span>
            <p style="font-size:0.9rem; margin-top:20px;">Ser√°s redirigido para ver el resumen.</p>
            <button id="close-modal-btn" class="modal-close-btn">
                Ver Resumen
            </button>
        </div>
    </div>


    <footer>
        <div class="footer-content">
            <div class="social-icons">
                <a href="#"><i class="fab fa-instagram"></i></a>
                <a href="#"><i class="fab fa-facebook-f"></i></a>
                <a href="#"><i class="fab fa-whatsapp"></i></a>
            </div>
            <div class="footer-links">
                <a href="terminos.html">T√©rminos y Condiciones</a>
                <a href="mailto:soporte@happycorner.lol">Cont√°ctanos</a>
                <a href="catalogo.html">Ver Todo el Cat√°logo</a>
            </div>
        </div>
    </footer>

    <script>
        /* ------------------ Utiles DOM ------------------ */
        function toggleMenu(){ document.getElementById('menu').classList.toggle('open'); }

        const cartItemsList = document.getElementById('cart-items-list');
        const subtotalPriceSpan = document.getElementById('subtotal-price');
        const shippingPriceSpan = document.getElementById('shipping-price');
        const totalPriceSpan = document.getElementById('total-price');
        const emptyCartMessage = document.getElementById('empty-cart-msg');

        const paymentMethodSelect = document.getElementById('metodo_pago');
        const puntosCodeInput = document.getElementById('puntos_code');
        const consultarPuntosBtn = document.getElementById('consultar-puntos-btn');
        const checkoutForm = document.getElementById('checkout-form');
        const orderNumberHidden = document.getElementById('order-number-hidden');
        const orderSummaryInput = document.getElementById('order-summary-input');
        const totalPriceHidden = document.getElementById('total-price-hidden');
        const cartContentHidden = document.getElementById('cart-content-hidden');
        const happyCodeHiddenFinal = document.getElementById('happycode-hidden-final');

        const VERCEL_API_BASE_URL = 'https://happy-corner.vercel.app/api'; 

        let cart = JSON.parse(localStorage.getItem('happyCart')) || [];

        function formatCurrency(amount) {
            // Formato de moneda colombiana: $1.000.000
            return '$' + amount.toLocaleString('es-CO'); 
        }

        function generateOrderNumber(){
            const datePart = new Date().toISOString().slice(0,10).replace(/-/g,'');
            const randomPart = Math.floor(100 + Math.random() * 900);
            return `HP-${datePart}-${randomPart}`;
        }
        
        function generateHappyCode() {
            const characters = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return 'HO-' + code; // HO = Happy Order
        }

        // Funci√≥n de consulta de Happy Puntos (Simulada)
        async function applyHappyPuntos() {
            const code = puntosCodeInput.value.trim();

            if (!code) {
                alert('Por favor, introduce tu HappyC√≥digo.');
                return;
            }

            consultarPuntosBtn.disabled = true;
            consultarPuntosBtn.textContent = 'Consultando...';

            try {
                // Simulaci√≥n de respuesta
                await new Promise(resolve => setTimeout(resolve, 1000)); 

                const data = {
                    nombre: 'Happy Customer',
                    correo: 'happy@corner.lol',
                    puntos: 1500,
                    happyCodigo: code,
                    error: null 
                };
                
                if (data.error) throw new Error(data.error);

                let mensaje = `üéâ ¬°HappyC√≥digo v√°lido!\n\nüë§ Cliente: ${data.nombre}\nüìß Correo: ${data.correo}\nüíé Puntos disponibles: ${data.puntos.toLocaleString('es-CO')}\n\n`;

                if (confirm(mensaje + '¬øDeseas aplicar estos datos al formulario?')) {
                    document.getElementById('nombre').value = data.nombre || '';
                    document.getElementById('email').value = data.correo !== 'No registrado' ? data.correo : '';
                    document.getElementById('celular').value = ''; 

                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'HappyC√≥digo_Cliente';
                    hiddenInput.value = data.happyCodigo;
                    checkoutForm.appendChild(hiddenInput);

                    alert('‚úÖ Datos aplicados con √©xito.');
                } 

            } catch (err) {
                console.error('Error al consultar Happy Puntos:', err);
                alert(`‚ùå Error: ${err.message || 'No se pudo verificar el c√≥digo.'}`);
            } finally {
                consultarPuntosBtn.disabled = false;
                consultarPuntosBtn.textContent = 'Consultar';
            }
        }

        /* ------------------ Render / Actualizaci√≥n de Carrito ------------------ */
        function renderCart(){
            cartItemsList.innerHTML = '';
            let subtotal = 0;
            const placeOrderBtn = document.getElementById('place-order-button');
            const orderTotalsDiv = document.querySelector('.order-totals');

            if(!cart || cart.length === 0){
                emptyCartMessage.style.display = 'block';
                orderTotalsDiv.style.display = 'none';
                placeOrderBtn.disabled = true;
                updateOrderSummaryForFormSubmit(0);
                return;
            } else {
                emptyCartMessage.style.display = 'none';
                orderTotalsDiv.style.display = 'block';
                placeOrderBtn.disabled = false;
            }

            cart.forEach((item, index) => {
                const totalItemPrice = Number(item.price) * item.quantity;
                
                const li = document.createElement('li');
                li.innerHTML = `
                    <div class="item-details">
                        <span class="item-name">${item.name}</span>
                        <span class="item-price">${formatCurrency(item.price)} c/u</span>
                    </div>
                    <div class="item-controls">
                        <button type="button" class="qty-minus" data-index="${index}">-</button>
                        <span class="quantity">${item.quantity}</span>
                        <button type="button" class="qty-plus" data-index="${index}">+</button>
                    </div>
                    <span class="item-total">${formatCurrency(totalItemPrice)}</span>
                `;
                
                cartItemsList.appendChild(li);

                const minusBtn = li.querySelector('.qty-minus');
                const plusBtn = li.querySelector('.qty-plus');

                minusBtn.addEventListener('click', (e) => updateQuantity(Number(e.target.dataset.index), -1));
                plusBtn.addEventListener('click', (e) => updateQuantity(Number(e.target.dataset.index), 1));

                subtotal += totalItemPrice;
            });

            subtotalPriceSpan.textContent = formatCurrency(subtotal);

            // Costo de env√≠o (Siempre Gratis en este ejemplo)
            const shippingCost = 0; 
            shippingPriceSpan.textContent = 'Gratis';

            const total = subtotal + shippingCost;
            totalPriceSpan.textContent = formatCurrency(total);

            updateOrderSummaryForFormSubmit(total);
        }

        function updateQuantity(index, change){
            if(!cart[index]) return;

            const currentQuantity = cart[index].quantity || 0;
            const newQuantity = currentQuantity + change;

            // VALIDACI√ìN DE L√çMITE DE PIZZAS (Tu correcci√≥n)
            const isPizza = cart[index].name.toLowerCase().includes('pizza');
            const MAX_PIZZAS = 5;
            
            if (isPizza && change === 1 && newQuantity > MAX_PIZZAS) {
                alert(`‚ùå ¬°L√≠mite de ${MAX_PIZZAS} pizzas alcanzado! Para pedidos mayores, cont√°ctanos por WhatsApp.`);
                return; 
            }
            // FIN DE VALIDACI√ìN

            if (newQuantity <= 0) {
                cart.splice(index, 1); 
            } else {
                cart[index].quantity = newQuantity;
            }

            localStorage.setItem('happyCart', JSON.stringify(cart));
            cart = JSON.parse(localStorage.getItem('happyCart')) || []; 
            renderCart();
        }

        function updateOrderSummaryForFormSubmit(total) {
            // 1. Crear resumen legible para el email
            let summaryText = cart.map(item => `${item.quantity}x ${item.name} (${formatCurrency(item.price)} c/u)`).join('; ');
            
            // 2. Crear contenido del carrito para el email (JSON)
            const cartContent = JSON.stringify(cart);

            orderSummaryInput.value = summaryText;
            totalPriceHidden.value = formatCurrency(total);
            cartContentHidden.value = cartContent;
        }

        /* ------------------ Payment details toggles ------------------ */
        const paymentDetailsDivs = {
            'nequi': document.getElementById('nequi-details'),
            'pse': document.getElementById('pse-details'),
            'applepay': document.getElementById('applepay-details'),
            'tarjeta': document.getElementById('tarjeta-details'),
            'efectivo': document.getElementById('efectivo-details')
        };

        function updatePaymentDetailsDisplay(){
            for(const k in paymentDetailsDivs){
                if(paymentDetailsDivs[k]) paymentDetailsDivs[k].style.display = 'none';
            }
            const selected = paymentMethodSelect.value;
            if(paymentDetailsDivs[selected]) paymentDetailsDivs[selected].style.display = 'block';
        }

        paymentMethodSelect.addEventListener('change', updatePaymentDetailsDisplay);


        /* ------------------ Form Submission Handler ------------------ */
        let happyCode = '';

        checkoutForm.addEventListener('submit', function(event) {
            if (cart.length === 0) {
                event.preventDefault();
                alert('Tu carrito est√° vac√≠o. ¬°A√±ade productos antes de ordenar!');
                return;
            }
            
            // Generar Happy Code y asignarlo a los inputs ocultos
            happyCode = generateHappyCode();
            document.getElementById('order-number-hidden').value = generateOrderNumber();
            document.getElementById('happycode-hidden-final').value = happyCode; 
            
            // Si el formulario se env√≠a exitosamente a FormSubmit.co, puedes usar el modal para mostrar el c√≥digo.
            // Para ver el modal inmediatamente (si no usas formsubmit.co):
            // event.preventDefault();
            // showSuccessModal(); 
        });

        function showSuccessModal() {
            document.getElementById('happy-code-display').textContent = happyCode;
            document.getElementById('order-success-modal').style.display = 'flex';
        }

        document.getElementById('close-modal-btn').addEventListener('click', function() {
            document.getElementById('order-success-modal').style.display = 'none';
            // Limpiar carrito despu√©s de un env√≠o exitoso
            localStorage.removeItem('happyCart');
            cart = [];
            renderCart();
            window.scrollTo(0, 0); 
        });

        consultarPuntosBtn.addEventListener('click', applyHappyPuntos);
        document.addEventListener('DOMContentLoaded', renderCart);
        document.addEventListener('DOMContentLoaded', updatePaymentDetailsDisplay);
    </script>
</body>
</html>
