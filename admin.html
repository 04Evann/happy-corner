<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0B0E14; --card: #151921; --accent: #D4AF37;
            --text: #FFFFFF; --text-sec: #717681; --border: #242933;
        }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Plus Jakarta Sans', sans-serif; }
        
        /* LOGIN OVERLAY */
        #auth-overlay {
            position: fixed; inset: 0; background: var(--bg); z-index: 10000;
            display: flex; align-items: center; justify-content: center;
        }

        /* HEADER */
        .header {
            padding: 20px 5%; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border); background: rgba(11, 14, 20, 0.8); backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 100;
        }

        /* BENTO GRID */
        .dashboard { padding: 30px 5%; display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .bento { background: var(--card); border-radius: 24px; padding: 25px; border: 1px solid var(--border); }

        /* INPUTS MD3 */
        input, select { 
            background: #1C222C; border: 1px solid var(--border); color: white; 
            padding: 12px; border-radius: 12px; outline: none; width: 100%; box-sizing: border-box;
        }

        .btn-gold { background: var(--accent); color: black; border: none; padding: 12px 20px; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .btn-gold:hover { transform: scale(1.02); box-shadow: 0 0 20px rgba(212,175,55,0.3); }

        .order-card { padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; justify-content: space-between; transition: 0.2s; }
        .order-card:hover { background: #1C222C; border-radius: 15px; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-content { background: var(--card); width: 90%; max-width: 450px; padding: 30px; border-radius: 28px; border: 1px solid var(--accent); }
        
        .nav-chips { display: flex; gap: 10px; margin-bottom: 20px; }
        .chip { padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border); cursor: pointer; font-size: 13px; }
        .chip.active { border-color: var(--accent); color: var(--accent); }

        .external-links a { color: var(--text-sec); text-decoration: none; font-size: 12px; margin-left: 15px; transition: 0.3s; }
        .external-links a:hover { color: var(--accent); }
    </style>
</head>
<body>

    <div id="auth-overlay">
        <div class="bento" style="text-align: center; width: 320px;">
            <img src="Happylogo.png" width="80" alt="Logo">
            <h2 style="margin: 20px 0 10px;">CEO Access</h2>
            <p style="color: var(--text-sec); font-size: 13px; margin-bottom: 20px;">Ingresa tu Chat ID de Telegram</p>
            <input type="text" id="auth-id" placeholder="Chat ID" style="text-align: center; margin-bottom: 15px;">
            <button class="btn-gold" style="width: 100%;" onclick="sendToken()">Solicitar Token</button>
            <div id="otp-area" style="display: none; margin-top: 15px;">
                <input type="text" id="auth-otp" placeholder="C√≥digo de 4 d√≠gitos" style="text-align: center; margin-bottom: 15px;">
                <button class="btn-gold" style="width: 100%; background: white;" onclick="validateToken()">Entrar</button>
            </div>
        </div>
    </div>

    <header class="header">
        <div style="display: flex; align-items: center; gap: 10px;">
            <img src="Happylogo.png" width="35">
            <span style="font-weight: 700; font-size: 18px;">HAPPY CORNER</span>
        </div>
        <div class="external-links">
            <a href="https://github.com" target="_blank">GITHUB</a>
            <a href="https://vercel.com" target="_blank">VERCEL</a>
            <a href="#" onclick="logout()" style="color: #FF4B4B;">LOGOUT</a>
        </div>
    </header>

    <main class="dashboard">
        <section>
            <div class="nav-chips">
                <div class="chip active" onclick="setView('active', this)">Dashboard</div>
                <div class="chip" onclick="setView('trash', this)">Papelera</div>
                <input type="date" id="date-picker" onchange="fetchByDate()" style="width: auto; padding: 5px 10px;">
            </div>

            <div class="bento">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <div>
                        <span style="color: var(--text-sec); font-size: 12px; font-weight: 600;">GANANCIAS SELECCI√ìN</span>
                        <h1 id="total-val" style="margin: 5px 0; font-size: 32px;">$0</h1>
                    </div>
                </div>
                <div id="orders-container"></div>
            </div>
        </section>

        <aside>
            <div class="bento" style="margin-bottom: 20px;">
                <h3 style="margin-top: 0; font-size: 16px;">Loyverse Insight</h3>
                <div id="loyverse-box" style="color: var(--text-sec); font-size: 14px;">
                    Selecciona una orden para cargar puntos.
                </div>
            </div>
            <div class="bento" style="background: linear-gradient(135deg, #1C222C, #0B0E14);">
                <h3 style="margin-top: 0; color: var(--accent);">CEO 2026/2027</h3>
                <p style="font-size: 13px; color: var(--text-sec);">M√©tricas proyectadas y reportes de inventario.</p>
                <button class="btn-gold" style="width: 100%; font-size: 12px;">DESCARGAR REPORTES</button>
            </div>
        </aside>
    </main>

    <div class="modal" id="orderModal" onclick="if(event.target == this) closeModal()">
        <div class="modal-content" id="modalBody"></div>
    </div>

    <script>
        let otpMaster = "";
        let msgIdMaster = "";
        const API = "https://happy-corner.vercel.app/api/getOrders";

        // --- AUTH LOGIC ---
        async function sendToken() {
            const chatId = document.getElementById('auth-id').value;
            otpMaster = Math.floor(1000 + Math.random() * 9000).toString();
            
            const resp = await fetch('https://happy-corner.vercel.app/api/sendotp', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ chatId, otp: otpMaster })
            });
            
            if(resp.ok) {
                const data = await resp.json();
                msgIdMaster = data.msgId; // Capturamos el ID del mensaje
                document.getElementById('otp-area').style.display = 'block';
                alert("Token enviado a Telegram");
            }
        }

        async function validateToken() {
            if(document.getElementById('auth-otp').value === otpMaster) {
                document.getElementById('auth-overlay').style.display = 'none';
                // Limpiar telegram
                fetch(`${API}?action=cleanTG&msgId=${msgIdMaster}`);
                loadOrders();
            } else { alert("Token incorrecto"); }
        }

        // --- DATA LOGIC ---
        async function setView(v, el) {
            document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            loadOrders(v);
        }

        async function fetchByDate() {
            const date = document.getElementById('date-picker').value;
            loadOrders(null, date);
        }

        async function loadOrders(view = 'active', date = null) {
            let url = `${API}?view=${view}`;
            if(date) url = `${API}?date=${date}`;

            const r = await fetch(url);
            const data = await r.json();
            const container = document.getElementById('orders-container');
            let total = 0;
            container.innerHTML = '';

            data.forEach(p => {
                if(p.estado === 'Entregado') total += parseInt(p.total.replace(/\D/g,'')) || 0;
                container.innerHTML += `
                    <div class="order-card" onclick="openOrder(${JSON.stringify(p).replace(/"/g, '&quot;')})">
                        <div>
                            <div style="font-weight:700;">${p.nombre}</div>
                            <div style="font-size:12px; color:var(--text-sec);">${p.whatsapp}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="color:var(--accent); font-weight:700;">${p.total}</div>
                            <div style="font-size:10px; opacity:0.5;">${p.estado}</div>
                        </div>
                    </div>`;
            });
            document.getElementById('total-val').innerText = `$${total.toLocaleString()}`;
        }

        async function openOrder(p) {
            document.getElementById('orderModal').style.display = 'flex';
            const lvRes = await fetch(`${API}?phone=${p.whatsapp}`);
            const lv = await lvRes.json();
            
            document.getElementById('modalBody').innerHTML = `
                <h2 style="margin:0 0 15px;">${p.nombre}</h2>
                <div style="background:#1C222C; padding:15px; border-radius:15px; margin-bottom:20px; font-size:14px;">
                    <p>üì± <b>WhatsApp:</b> ${p.whatsapp}</p>
                    <p>üì¶ <b>Pedido:</b> ${p.resumen || 'Detalle no disponible'}</p>
                    <p>üèÜ <b>Loyverse:</b> <span style="color:var(--accent)">${lv.total_points || 0} Puntos</span></p>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <button class="btn-gold" onclick="updateStatus(${p.id}, 'Entregado')">COMPLETAR</button>
                    <button class="btn-gold" style="background:#242933; color:white;" onclick="updateStatus(${p.id}, 'Cancelado')">CANCELAR</button>
                    <button class="btn-gold" style="grid-column: span 2; background:#25D366; color:white;" onclick="window.open('https://wa.me/${p.whatsapp}')">ENVIAR WHATSAPP</button>
                </div>
            `;
        }

        async function updateStatus(id, est) {
            await fetch(`${API}?id=${id}&estado=${est}`, { method: 'POST' });
            closeModal();
            loadOrders();
        }

        function closeModal() { document.getElementById('orderModal').style.display = 'none'; }
        function logout() { location.reload(); }
    </script>
</body>
</html>
